#Enable inheritance using icacls
Invoke-Expression "C:\Windows\System32\icacls.exe C:\Windows\System32\config\*.* /inheritance:e"

#Verify the ACL change
$SAMACL = (Get-Acl -Path "C:\Windows\System32\config\SAM").Access | Where-Object {$PSITEM.IdentityReference -eq "BUILTIN\Users"}
If($SAMACL){
    If($SAMACL.FileSystemRights.ToString().Contains("Read")){
        $ACLStatus = "NOTOK"
    }
    Else{
        $ACLStatus = "OK"
    }
}
Else{
    $ACLStatus = "OK"
}

#Remove all shadow copies
Invoke-Expression "C:\Windows\System32\vssadmin.exe delete shadows /quiet /all" | Out-Null

#Query shadow copy count
$ShadowCopyCount = Get-WmiObject -Class Win32_ShadowCopy | Measure-Object | Select-Object -ExpandProperty Count
If($ShadowCopyCount -eq 0){
    $ShadowDeleteStatus = "OK"
}
Else{
    $ShadowDeleteStatus = "NOTOK"
}

If($ACLStatus -eq "OK" -and $ShadowDeleteStatus -eq "OK"){
    
    #https://docs.microsoft.com/en-us/previous-versions/windows/desktop/vsswmi/create-method-in-class-win32-shadowcopy
    $ShadowCopyClass = [WMICLASS]"root\cimv2:Win32_ShadowCopy"
    $CreateNewShadowCopy = ($ShadowCopyClass.Create("C:\","ClientAccessible")).ReturnValue

    Write-Output "OK"

}
Else{
    Write-Output "NOTOK"
}
